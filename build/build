#!/usr/bin/env python

from datetime import datetime
import email.utils
import io
from jinja2 import Environment, FileSystemLoader
import os
import time
from xml.sax.saxutils import escape


def format_date(d):
    return email.utils.formatdate(time.mktime(d.timetuple()))


def main():
    template_env = Environment(loader=FileSystemLoader('build/'))

    entries = []

    with io.open('news.txt', encoding='utf-8') as fp_:
        fp = (l.strip() for l in fp_)
        try:
            while True:
                title = next(fp)
                if not title:
                    continue
                link = next(fp)
                date = next(fp)
                date = datetime.strptime(date, '%Y-%m-%d')
                date = format_date(date)
                description = []
                try:
                    while True:
                        line = next(fp)
                        if not line:
                            line = next(fp)
                            if not line:
                                break
                            else:
                                description.append('')
                        description.append(line)
                except StopIteration:
                    pass
                description = '\n'.join(description)

                entries.append({
                    'title': escape(title),
                    'link': escape(link),
                    'date': escape(date),
                    'description': escape(description)
                })
        except StopIteration:
            pass

    template = template_env.get_template('feed.rss.tpl')

    if not os.path.isdir('target'):
        os.mkdir('target')

    with io.open('target/feed.rss', 'w', encoding='utf-8') as fp:
        for chunk in template.generate({'items': entries}):
            fp.write(chunk)


if __name__ == '__main__':
    main()
